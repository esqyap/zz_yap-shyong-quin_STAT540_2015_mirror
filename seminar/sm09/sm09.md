# sm09
Eva Y  
March 12, 2015  

### Take-home problem: 
(1) draw a plot with number of clusters in the x-axis and the average silhouette widths in the y-axis. Use the information obtained to determine if 5 was the best choice for the number of clusters.
(2)For a common choice of k, compare the clustering across different methods, e.g. hierarchical (pruned to specific k, obviously), k-means, PAM. You will re-discover the “label switching problem” for yourself. How does that manifest itself? How concordant are the clusterings for different methods?

#### Load packages and data. Perform some modifications to the dataset. 

```r
library(RColorBrewer)
library(cluster)
library(pvclust)
library(xtable)
library(limma)
library(plyr)
library(lattice)

prDat <- read.table("../../data/GSE4051_data.tsv", 
                    header = TRUE, row.names = 1)
str(prDat, max.level = 0)
```

```
## 'data.frame':	29949 obs. of  39 variables:
```

```r
prDes <- readRDS("../../data/GSE4051_design.rds")
str(prDes)
```

```
## 'data.frame':	39 obs. of  4 variables:
##  $ sidChar : chr  "Sample_20" "Sample_21" "Sample_22" "Sample_23" ...
##  $ sidNum  : num  20 21 22 23 16 17 6 24 25 26 ...
##  $ devStage: Factor w/ 5 levels "E16","P2","P6",..: 1 1 1 1 1 1 1 2 2 2 ...
##  $ gType   : Factor w/ 2 levels "wt","NrlKO": 1 1 1 1 2 2 2 1 1 1 ...
```

```r
# scale data, minus mean divided by sd
sprDat <- t(scale(t(prDat)))
str(sprDat, max.level = 0, give.attr = FALSE)
```

```
##  num [1:29949, 1:39] 0.0838 0.1758 0.7797 -0.3196 0.8358 ...
```

```r
# compute pairwise distances
pr.dis <- dist(t(sprDat), method = 'euclidean')

# create a new factor representing the interaction of gType and devStage
prDes$grp <- with(prDes, interaction(gType, devStage))
summary(prDes$grp)
```

```
##        wt.E16     NrlKO.E16         wt.P2      NrlKO.P2         wt.P6 
##             4             3             4             4             4 
##      NrlKO.P6        wt.P10     NrlKO.P10    wt.4_weeks NrlKO.4_weeks 
##             4             4             4             4             4
```

#### Q1: 

```r
# PAM algorithm
# number of clusters
k <- 2:30

# make function give average silhouette width
get_avg_swidth <- function(k){
  pr.pam <- pam(pr.dis, k=k)
  pr.pam_sum <- summary(pr.pam)
  avg_swidth <- pr.pam_sum$silinfo$avg.width
  avg_swidth
}

# apply the function to a vector 2:30
avg_swidth_df <- data.frame(clusters=c(2:30), 
                            avg_width=sapply(k, get_avg_swidth))

# plot avg width vs. clusters
xyplot(avg_width ~ clusters, avg_swidth_df, xlab="Number of Clusters", ylab="Average Silhouette Width")
```

![](sm09_files/figure-html/unnamed-chunk-2-1.png) 

#### Q2: 

```r
# pick k=4 because after that the average silhouette width drops based on the plot in Q1. 
# this is the elbow/knee curve some discussions are referring to...
k <- 4
```

##### Generate hierarchical clustering:

```r
pr_hc <- hclust(pr.dis, method = 'complete')

# identify 4 clusters
op <- par(mar = c(1,4,4,1))
plot(pr_hc, labels = prDes$grp, cex = 0.6, 
     main = "Complete HC showing 4 clusters")
rect.hclust(pr_hc, k = 4)
```

![](sm09_files/figure-html/unnamed-chunk-4-1.png) 

```r
# make data frame
pr_hc <- cutree(pr_hc, k=k)
pr_hc_df <- data.frame(pr_hc)
colnames(pr_hc_df) <- "hc"
```

##### Perform kmeans clustering:

```r
set.seed(1)
pr_km <- kmeans(t(sprDat), centers = k, nstart =  50)

# make data frame
pr_km_df <- data.frame(km=pr_km$cluster)
```

##### Perform PAM:

```r
pr_pam <- pam(pr.dis, k = k)

# make data frame
pr_pam_df <- data.frame(pm=pr_pam$clustering)
```

##### Label switching problem: 
The problem is that clustering of similar samples to a group can be named differently between different methods. For example, if sample 1, 2, and 3 are designated cluster 1 using kmeans, the same cluster consisting of the same samples (1, 2, and 3) can be named cluster 2. That's pretty annoying. How could we tell concordance?

```r
all_clust <- cbind(prDes$grp, pr_hc_df, pr_pam_df, pr_km_df)
all_clust
```

```
##               prDes$grp hc pm km
## Sample_20        wt.E16  1  1  4
## Sample_21        wt.E16  2  1  4
## Sample_22        wt.E16  1  1  4
## Sample_23        wt.E16  1  1  4
## Sample_16     NrlKO.E16  3  2  1
## Sample_17     NrlKO.E16  2  1  4
## Sample_6      NrlKO.E16  2  1  4
## Sample_24         wt.P2  3  3  3
## Sample_25         wt.P2  1  3  3
## Sample_26         wt.P2  3  2  1
## Sample_27         wt.P2  3  2  1
## Sample_14      NrlKO.P2  3  3  3
## Sample_3       NrlKO.P2  3  3  3
## Sample_5       NrlKO.P2  3  2  1
## Sample_8       NrlKO.P2  3  2  1
## Sample_28         wt.P6  3  2  1
## Sample_29         wt.P6  4  1  4
## Sample_30         wt.P6  1  3  3
## Sample_31         wt.P6  3  3  3
## Sample_1       NrlKO.P6  1  3  3
## Sample_10      NrlKO.P6  1  3  3
## Sample_4       NrlKO.P6  1  3  3
## Sample_7       NrlKO.P6  3  2  1
## Sample_32        wt.P10  4  4  2
## Sample_33        wt.P10  3  2  1
## Sample_34        wt.P10  3  2  1
## Sample_35        wt.P10  3  3  3
## Sample_13     NrlKO.P10  1  3  2
## Sample_15     NrlKO.P10  1  3  3
## Sample_18     NrlKO.P10  4  3  2
## Sample_19     NrlKO.P10  1  3  3
## Sample_36    wt.4_weeks  4  4  2
## Sample_37    wt.4_weeks  1  4  2
## Sample_38    wt.4_weeks  1  4  2
## Sample_39    wt.4_weeks  1  4  2
## Sample_11 NrlKO.4_weeks  1  4  2
## Sample_12 NrlKO.4_weeks  3  3  3
## Sample_2  NrlKO.4_weeks  1  4  2
## Sample_9  NrlKO.4_weeks  1  1  4
```

By eyeballing this table, we can sort of tell that cluster results are more concordant between PAM and kmeans.

To validate two cluster solutions, we can use `cluster.stats()` from the `fpc` package. *Coming soon...*


